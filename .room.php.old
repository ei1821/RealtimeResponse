<?php
    require_once __DIR__."/utils/utils.php";
    session_start();

    if (isset($_SESSION['id'])) {//ログインしているとき
        $msg = 'こんにちは' . htmlspecialchars($username, \ENT_QUOTES, 'UTF-8') . 'さん';
        $link = '<a href="logout.php">ログアウト</a>';
        $db = new MyDB();
    } else {//ログインしていない時
        $msg = 'ログインしていません';
        $link = '<a href="signin.php">ログイン</a>';
        echo "$msg<br>$link";
        exit;
    }
    if(isset($_SESSION["room_id"])) {
        $room_id = $_SESSION["room_id"];
        $room_name = $_SESSION["room_name"];
    }
    else {

        $res = $db->query("SELECT * FROM `rooms` WHERE owner_id=$user_id AND is_closed=0");
        if($res["count"] > 0) {
            $res = $res["result"][0];
            $room_id = $res["id"];
            $room_name = $res["name"];
            $_SESSION["room_id"] = $room_id;
            $_SESSION["room_name"] = $room_name;
        }
        else {
            $msg = "ルームを作成していません。";
            echo "$msg<br><a href='createroom.php'>ルームを作る</a>";
            exit;
        }
    }

?>
<!DOCTYPE html>
<html lang="ja">
 <head>
 <meta charset="utf-8">
 <title>なんかのサイトのホーム</title>
 <meta name="description" content="ディスクリプションを入力">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="stylesheet" href="style.css">
 <!-- [if lt IE 9] -->
 <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
 <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
 <!-- [endif] -->
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
 <script src="https://d3js.org/d3.v7.min.js"></script>
 <script >

  d3.select("body").append("p").text("Hello!");
     $(() => poll());
async function poll() {

    var id = <?= $room_id ?>;
    try {
        const response = await $.getJSON("response_ajax.php?room_id=" + id);
        console.log(response);
        //$('#response').prepend("<p>good : " + response.good + " bad : " + response.bad + "</p>");

    } catch (e) {
        console.error(e);
    } finally {
        setTimeout(poll, 1000);
    }
}
      var svg = d3.select("body").append("svg").attr("width", 500).attr("height", 100);
      var dataset = [1, 2, 3, 4, 5];
      var circles = svg.selectAll("circle")
        .data(dataset)
        .enter()
        .append("circle");
      circles.attr("cx", function(d, i) {
        return (i * 50) + 25;
      })
      .attr("cy", 50)
      .attr("r", function(d) {
        return 5*d;
      })
      .attr("fill", "yellow")
      .attr("stroke", "orange")
      .attr("stroke-width", function(d) {
        return d;
      });

 </script>
 </head>
 <body>
 <!----- header----->
 <header><?= $msg ?></header>
 <nav></nav>
 <!----- /header ----->

 <!----- main ----->
 <article>
<h1><?= $room_name ?></h1>
<h2>理解度チェック</h2>
<div id="res-svg">
  <svg width="500" height="100">
  </svg>
</div>
<div id="response">
<p>個々に色々表示</p>
</div>

<br><br>

<a href="room_close.php">ルームを閉じる</a>

</section>
 </article>
 <!----- /main ----->

 <!----- footer ----->
 <!----- /footer ----->
 </body>
</html>
